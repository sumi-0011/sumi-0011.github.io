# 5. Format String Bug

# Variadic Function

(feat. Printf)

![Untitled](5%20Format%20S%202e31c/Untitled.png)

- `myprinf()`ëŠ” `printf()`ì˜ ì‹¤ì œ ë™ì‘ê³¼ì •ì„ ë³´ì—¬ì¤Œ
- `va_list` pointerì€ optional argumentì— access
- `var_start()` ì€ `Narg`ë¥¼ ê¸°ë°˜ìœ¼ë¡œ `va_list`ì˜ initial positionì„ ê³„ì‚°

![Untitled](5%20Format%20S%202e31c/Untitled%201.png)

- `var_start()` macroëŠ” `Narg`ì˜ ì‹œì‘ ì£¼ì†Œë¥¼ ê°€ì ¸ì˜¤ê³ , data typeì— ê¸°ë°˜í•œ sizeë¥¼ ì°¾ì•„ `va_list` pointerì˜ ê°’ì„ ì„¤ì •í•œë‹¤.
- `var_list` pointer ì€ `va_arg()` macroë¥¼ ì‚¬ìš©í•˜ì—¬ ì§„í–‰
- `va_arg(ap, int`  : `ap` pointerì„ 4bytes ìœ„ë¡œ ì´ë™
- ëª¨ë“  optional argumentì— accessedí•˜ë©´, `va_end()`ê°€ í˜¸ì¶œ

`printf()` ëŠ” 3ê°œì˜ optional argumentê°€ ì¡´ì¬í•œë‹¤. `%` ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” elementëŠ” format specifier

`printf()`ëŠ” format stringì„ printí•˜ê³ , `%`ê°€ ì…ë ¥ë  ë•Œê¹Œì§€ ê° ë¬¸ìë¥¼ ì¸ì‡„í•œë‹¤. 

`printf()`ê°€ `va_arg()`ë¥¼ í˜¸ì¶œí•˜ë©´, `va_list`ê°€ ê°€ë¥´í‚¤ëŠ” optional argumentë¥¼ ë°˜í™˜í•˜ê³  ë‹¤ìŒ argumentë¡œ ì§„í–‰ëœë‹¤. 

![Untitled](5%20Format%20S%202e31c/Untitled%202.png)

- `printf()`ê°€ í˜¸ì¶œë˜ë©´, argumentê°€ ì—­ìˆœìœ¼ë¡œ stackì— pushëœë‹¤
- format stringì„ scaní•˜ê³ , printí• ë•Œ `printf()`ëŠ” ì²«ë²ˆì§¸ oprional argumentì™€ ë°”ê¾¸ê³ , valueë¥¼ printí•œë‹¤.
- `va_list`ëŠ” position 2ë¡œ ì´ë™í•œë‹¤.

### format stringì´ argumentì˜ ê°œìˆ˜ë³´ë‹¤ ë§ê²Œ ëœë‹¤ë©´? ğŸ¤”

- `va_arg()` macroëŠ” optional argument listì˜ endì— ë„ë‹¬ í•˜ì˜€ëŠ”ì§€ ì´í•´í•˜ì§€ ëª»í•œë‹¤.
- ê·¸ë˜ì„œ, stackì—ì„œ dataë¥¼ ê³„ì† ê°€ì ¸ì˜¤ë©°, `va_list` pointerì„ ì „ì§„ì‹œí‚¤ê²Œ ëœë‹¤.

â‡’ â—danger

# Format string

## Format Function ì˜ ì‘ë™ ë°©ì‹

- format stringì€ functionì˜ ë™ì‘ì„ ì œì–´í•œë‹¤.
    
    printí•´ì•¼í•˜ëŠ” parameterì˜ typeì„ ì§€ì •
    
- parameterì€ stackì— push ëœë‹¤. (stackì— ì €ì¥ë¨)
    
    directly or indirectly
    

| parameter | Meaning | Passed as |
| --- | --- | --- |
| %d | int | value |
| %u | unsigned int | value |
| %x | 16ì§„ìˆ˜ unsigned int | value |
| %s | string | reference |
| %n | ì“°ì—¬ì§„ byte ê°œìˆ˜ (int) | reference |

```wasm
printf(input);

input = "hello" => output : Hello
input = "%x" => output : ??
```

**ìœ„ì™€ ê°™ì€ ìƒí™©ì—ì„œ ì–´ë–¤ outputì´ ë‚˜ì˜¤ê²Œ ë ê¹Œ?** == ì–´ë–¤ ê²ƒì„ í—ˆìš©í•˜ê²Œ ë ê¹Œ?

â‡’ outputì€ stackì— ìˆëŠ” valueê°€ ëœë‹¤ (í˜„ì¬ stack pointerê°€ ê°€ë¥´í‚¤ëŠ” ê°’ ==  `ESP` )

`printf()` ë‚´ë¶€ì—ì„œ, optional argument(`va_list` pointer)ì˜ ì‹œì‘ì ì€ format string argumentì˜ ë°”ë¡œ ë’¤ì— ìœ„ì¹˜í•œë‹¤. 

![Untitled](5%20Format%20S%202e31c/Untitled%203.png)

# ğŸ˜® ìš°ë¦¬ê°€ ì‹œë„í•  ìˆ˜ ìˆëŠ” Attack

<aside>
ğŸ“– Attack 1 : Crash program

Attack 2 : Print out data on the stack

Attack 3 : Change the programâ€™s data in the memory

Attack 4 : Change the programâ€™s data to specific value

Attack 5 : Inject Malicious Code

</aside>

## Attack 1 : Crash Program

![Untitled](5%20Format%20S%202e31c/Untitled%204.png)

**ì‚¬ìš© input : `%s%s%s%s%s%s%s%s`** 

`printf()`ëŠ” format string ë¶„ì„ì„ ì‹œì‘í•˜ê³ , ê°ê°ì˜ `%s`ì— ëŒ€í•´ `va_list`ê°€ ê°€ë¥´í‚¤ëŠ” ê°’ì„ ê°€ì ¸ì™€ `va_list`ë¥¼ ë‹¤ìŒìœ„ì¹˜ë¡œ ì´ë™ì‹œí‚¤ëŠ”ë°

ìš°ë¦¬ê°€ `%s` ë¥¼ ì œê³µí•´ì£¼ë©´, `**printf()`ëŠ” valueë¥¼ addressë¡œ ì·¨ê¸‰**í•˜ì—¬, í•´ë‹¹ ì£¼ì†Œì—ì„œ dataë¥¼ ê°€ì ¸ì˜¤ê²Œ ëœë‹¤. ì´ë•Œ, valueê°€ ìœ íš¨í•œ addressê°€ ì•„ë‹ˆë©´, programì´ ì¶©ëŒë˜ê²Œ ëœë‹¤. 

## Attack 2 : print out data on the stack

![Untitled](5%20Format%20S%202e31c/Untitled%205.png)

`stack`ì— ë¹„ë°€ ê°’ì´ í¬í•¨ë˜ì–´ ìˆê³ , ìš°ë¦¬ê°€ ê·¸ê²ƒì„ printí•˜ê³  ì‹¶ë‹¤ê³  ê°€ì •í•œë‹¤. 

ì‚¬ìš© input : `%x%x%x%x%x%x%x%x`

`printf()`ëŠ” `va_list()` pointerê°€ ê°€ë¥´í‚¤ëŠ” integer valueë¥¼ ì¶œë ¥í•˜ê³ , 4btye ì•ìœ¼ë¡œ ì´ë™ì‹œí‚¨ë‹¤. 

`%x`ì˜ ê°œìˆ˜ëŠ” `va_list` pointerì˜ ì‹œì ì ê³¼ ë³€ìˆ˜ì‚¬ì´ì˜ ê±°ë¦¬ì— ì˜í•´ ê²°ì •ëœë‹¤. (ì—¬ëŸ¬ ì‹œí–‰ì°©ì˜¤ë¥¼ ê±°ì³ì•¼í•¨)

# Attack 3 : Change Programâ€™s Data in the
Memory

![Untitled](5%20Format%20S%202e31c/Untitled%206.png)

**Goal : `var`ë³€ìˆ˜ì˜ ê°’ì„ `0x11223344`ê°€ ì•„ë‹Œ ë‹¤ë¥¸ valueë¡œ ë³€ê²½í•˜ì**

`%n` : ì§€ê¸ˆê¹Œì§€ ì¶œë ¥ëœ characterì˜ ìˆ˜ë¥¼ memoryì— ì“´ë‹¤. 

â‡’ `va_list` pointerê°€ ê°€ë¥´í‚¤ëŠ” valueì„ memory addressë¡œ ì·¨ê¸‰í•˜ì—¬ ê·¸ ìœ„ì¹˜ì— ì“´ë‹¤. 

> printf(â€hello%nâ€, &i) â‡’ ì œê³µëœ memory ì£¼ì†Œì— 5ë¥¼ print
> 

**ë”°ë¼ì„œ, memoryì˜ ìœ„ì¹˜ì— ê°’ì„ ì“°ë ¤ë©´, stackì— í•´ë‹¹í•˜ëŠ” ì£¼ì†Œê°€ ìˆì–´ì•¼í•œë‹¤.** 

gbdë¥¼ ì‚¬ìš©í•˜ì—¬ ì°¾ì€ `var`ë³€ìˆ˜ì˜ ì£¼ì†Œê°€ `0xbffff304` ë¼ê³  ê°€ì •í•˜ì

```wasm
$echo $(printf "/x04/xf3/xff/xbf").%x.%x.%x.%x.%x.%x.%n > input
```

`var`ì˜ ì£¼ì†ŒëŠ” stackì— ì €ì¥ë˜ë„ë¡ inputì˜ ì‹œì‘ë¶€ë¶„ì— ë„£ê³ , 

$(command): command substitution. ëª…ë ¹ì˜ outputì´ commandìì²´ë¥¼ ëŒ€ì²´í•  ìˆ˜ ìˆë„ë¡ í•œë‹¤. 

`"/x04"` : â€œ04â€ê°€ ë‘ê°œì˜ ASCIIë¬¸ìê°€ ì•„ë‹Œ, ì‹¤ì œ ìˆ«ìì„ì„ ë‚˜íƒ€ë‚¸ë‹¤. 

 

![Untitled](5%20Format%20S%202e31c/Untitled%207.png)

- `var`ì˜ address (= `0xbffff304`ëŠ” stackì— ì¡´ì¬)
- Goal : `va_list` pointerë¥¼ í•´ë‹¹ ìœ„ì¹˜ë¡œ ì´ë™ì‹œí‚¤ê³ , `%n`ì„ ì´ìš©í•˜ì—¬ ì¼ë¶€ valueë¥¼ ì €ì¥í•œë‹¤.
- `%x`ì€ `va_list` ë¥¼ ì „ì§„ì‹œí‚¤ëŠ”ë° ì‚¬ìš©ëœë‹¤. â‡’ ì–¼ë§ˆë‚˜ ë§ì€ `%x`ê°€ í•„ìš”í• ê¹Œ?

![Untitled](5%20Format%20S%202e31c/Untitled%208.png)

> ì‹œí–‰ ì°©ì˜¤ë¥¼ í†µí•˜ì—¬, `0xbfff304`ë¥¼ ì¶œë ¥í•˜ëŠ”ë° ëª‡ê°œì˜ `%x` ê°€ í•„ìš”í•œì§€ í™•ì¸í•œë‹¤. 
ì—¬ê¸°ì—ëŠ” 6 format specifiersê°€ í•„ìš”í•˜ë‹¤. , 5ê°œì˜ `%x`ì™€ 1ê°œì˜ `%n` 
attack í›„ì—, target addressì˜ dataëŠ” 0x2c(=10ì§„ìˆ˜ 44)ë¡œ ìˆ˜ì •ëœë‹¤. 
WHY ? â‡’ `%n`ì´ì „ì— 44ìê°€ ì¶œë ¥ë˜ì—ˆê¸° ë•Œë¬¸
> 

## Attack 4 : Change Programâ€™s Data to a Specific Value

**Goal: To change the value of var from `0x11223344` to `0x9896a9`**

![Untitled](5%20Format%20S%202e31c/Untitled%209.png)

â­ 8 x 4 (`%.8x`) + 5 (`_` 5ê°œ) + 4 (`$(printf "/x04/xf3/xff/xbf")`)  + 10000000(`%.10000000`) = 10000041

â‡’ will be stored in `0xbffff304`.

![Untitled](5%20Format%20S%202e31c/Untitled%2010.png)

> %n : **4-byte** intege
%hn :  **2-byte** short integer. Overwrites only 2 significant bytes of the argument
%hhn : **1-byte** char type. Overwrites the least significant byte of the argument
> 

%n ì „ê¹Œì§€ì˜ charactor ê¸¸ì´ : 5

%n, %hn, %hhnì€ ê°ìì˜ `byte`ë§Œí¼ì„ write í•  ìˆ˜ ìˆë‹¤. 

**Goal: change the value of var to 0x66887799**

- Use `%hn` to modify the var variable two bytes at a time
    
    `%hn` : 2byteì”© ìª¼ê°œì„œ í”„ë¦°íŠ¸
    
- Break the memory of var into two parts, each with two bytes
    
    `var`ì˜ memoryë¥¼ ê°ê°€ê·¸ 2byteì”©, ë‘ê°œì˜ partë¡œ ë‚˜ëˆˆë‹¤.
    
- ëŒ€ë¶€ë¶„ì˜ ì»´í“¨í„°ëŠ” Little-Endian architecture
    
    little-endian : í°ê²Œ ì‘ì€ ì£¼ì†Œë¡œ ê°„ë‹¤. 
    0x11223344 â‡’ stackì˜ ë‚®ì€ ì£¼ì†Œì— 0x1122, ë†’ì€ ì£¼ì†Œì— 0x3344
    
    - The 2 least significant bytes (0x7799) are stored at address 0xbffff304
    - The 2 significant bytes (0x6688) are stored at 0xbffff306
    
    WHAT????
    â‡’ ì™œ ì‘ì€ê²Œ ì‘ì€ë°, í°ê²Œ í°ë°ì— ë“¤ì–´ê°€ì£ ..ğŸ¤¬
    
- If the first %hn gets value x, and before the next %hn, t more characters are print
ed, the second %hn will get value x+t.
    
    

![Untitled](5%20Format%20S%202e31c/Untitled%2011.png)

0xbffff306 ì£¼ì†Œ = 4byte

0xbffff304 ì£¼ì†Œ = 4byte

`@@@@` = 4byte

`_` * 5 = 5byte

`%.8x` * 4 â‡’ 32byte

    â†’ 49

%.26199x â‡’ 26199byte

ì²«ë²ˆì§¸ %hn â‡’ 4 + 4 + 4 + 32 + 5 + 26199 = 26248 ( 0x6688 )

ë‘ë²ˆì§¸ %hn â‡’ 4368

![Untitled](5%20Format%20S%202e31c/Untitled%2012.png)

- 0x6688(10ì§„ìˆ˜ 26248)ì„ printí•˜ë©´ 26248 - 49 = 26199ê°œì˜ ë¬¸ìê°€ í•„ìš”
- first address í›„ì— `%hn` ì„ ì‚¬ìš©í•œë‹¤ë©´, `va_list` ê°€ second addressë¥¼ ê°€ë¦¬í‚¤ê³  ê°™ì€ ê°’ì„ ì €ì¥í•œë‹¤.
- ë”°ë¼ì„œ, ë‘ addressì‚¬ì´ì— `@@@@` ì„ ë„£ì–´ %xë¥¼ í•˜ë‚˜ ë” ì‚½ì…í•˜ê³  ì¶œë ¥ ë˜ëŠ” ë¬¸ììˆ˜ë¥¼ 0x7799(30617)ë¡œ ëŠ˜ë¦°ë‹¤.
- first `%hn`ì´í›„ì— `va_list` pointerê°€ `@@@@` ì„ ê°€ë¦¬í‚¤ë©´ pointerê°€ second addressë¡œ ì´ë™í•œë‹¤. second `%hn`ì— ë„ë‹¬í–ˆì„ë•Œ, 0x7799 (30617)ì„ printí•˜ê¸° ìœ„í•´ 4368( =30617 - 26248 -1)ë¡œ ì„¤ì •í•œë‹¤.

## Attack 5 : Inject Malicious Code

**Goal : To modify the return address of the vulnerable code and let it point it to the malicious code (e.g., shellcode to execute /bin/sh) .Get root access if vulnerable code is a SET-UID program.**

â‡’ vulnerable codeì˜ return addressë¥¼ ìˆ˜ì •í•˜ì—¬, malicious codeë¥¼ ê°€ë¥´í‚¤ë„ë¡ í•œë‹¤. vulnerable codeê°€ set-uid í”„ë¡œê·¸ë¨ì¸ ê²½ìš°, root access ê¶Œí•œì„ ì–»ê²Œ ëœë‹¤. 

**Challenges**

- stackì— Malicious code ì£¼ì…
- injected codeì˜ start address(A) ì°¾ê¸°
- vulnerable codeì˜ return address(B) ì°¾ê¸°
- Aì˜ value(shell address) ë¥¼ B(return address)ì— ì“°ê¸°

gbdë¥¼ ì´ìš©í•˜ì—¬ ì•…ì„± ì½”ë“œì˜ return addressì™€ start addressë¥¼ get

return address â‡’ 0xbffff38c

ì•…ì„± ì½”ë“œì˜ start address â‡’ 0xbfff358

**Goal : Write the value 0xbffff358 to address 0xbffff38c**

1. 0xbffff38cë¥¼ ì¸ì ‘í•œ 2-byte ë©”ëª¨ë¦¬ ìœ„ì¹˜ë¡œ ë‚˜ëˆˆë‹¤. ( 0xbfff f38e, 0xbfff f38c )

2. Store 0xbfff into 0xbffff38e and 0xf358 into 0xbffff38c

![Untitled](5%20Format%20S%202e31c/Untitled%2013.png)

![Untitled](5%20Format%20S%202e31c/Untitled%2014.png)

## ìš°ë¦¬ì˜ ì´í•´ë¥¼ ë•ê¸° ìœ„í•˜ì—¬ ğŸ˜­

![Untitled](5%20Format%20S%202e31c/Untitled%2015.png)

![Untitled](5%20Format%20S%202e31c/Untitled%2016.png)

## BOF vs FSB

|  | buffer overflow | Format String |
| --- | --- | --- |
| public since | 1980(ë¨¼ì €!) | 1999 |
| ìœ„í—˜ì„±ì´ ì•Œë ¤ì§„ ë•Œ | 1990â€™s | 2000 |
| exploitê°œìˆ˜ | ë§ | ì  |
| considered as (ì·¨ê¸‰) | ë³´ì•ˆ ë¬¸ì œ | í”„ë¡œê·¸ë˜ë° bug |
| techniques | ê³„ì† ë°œì „ | basic techniques |
| visibility | very difficult to spot | easy to find |

## Countermeasures

### ê°œë°œì

Avoid using untrusted user inputs for format strings infunctions like printf, sprintf, fprintf, vprintf, scanf, vfscanf.

â‡’ user inputì´ formatìœ¼ë¡œ ë“¤ì–´ê°€ë©´ ì•ˆëœë‹¤. 

### Complier

Compilers can detect potential format string vulnerabilities

â‡’ ì°¾ê¸° ì‰¬ìš´ ë²„ê·¸

default settingì„ ì‚¬ìš©í•˜ë©´, `printf`ì— ëŒ€í•´ ê²½ê³ ë¥¼ í‘œì‹œí•œë‹¤. 

`wformat=2` optionì„ ì‚¬ìš©í•˜ë©´ format string is not a string literalë¼ëŠ” ê²½ê³ ë¥¼ í‘œì‹œí•œë‹¤. 

(! ê²½ê³ ë§Œ í•¨!)

### ë°©ì–´ ê¸°ë²•ë“¤

**Address randomization (ASLR)**

stackì´ë‚˜ codeì˜ ì£¼ì†Œë¥¼ í”„ë¡œê·¸ë¨ì´ ì‹¤í–‰ ë  ë•Œë§ˆë‹¤ ë‹¤ë¥´ê²Œ ë³€ê²½ì„ í•´ì¤€ë‹¤. 

ê³µê²©ìê°€ target memoryì˜ addressë¥¼ ì¶”ì¸¡í•˜ê¸° ì–´ë µê²Œ ë§Œë“¤ì–´, ë¯¸ë¦¬ ì£¼ì†Œë¥¼ ì•Œì•„ë‚´ í¬ë§·ì„ ì‘ì„±í• ìˆ˜ ì—†ë‹¤. 

but! ì–´ë– í•œ ë²„ê·¸(eagx?)ë¡œ runtimeì— ì£¼ì†Œë¥¼ ì•Œ ìˆ˜ ìˆìœ¼ë©´ ì—¬ì „íˆ ê³µê²©ì´ ê°€ëŠ¥í•˜ë‹¤. 

**Non-executable Stack/Heap**

Not work!

stack, heapì˜ ì‹¤í–‰ ê¶Œí•œì´ ì—†ìŒ

ê³µê²©ìëŠ” ì´ ëŒ€ì‘ì±…ì„ ë¬´ë ¥í™” í•˜ê¸° ìœ„í•˜ì—¬ `return-to-libc` ê¸°ë²•ì„ ì´ìš©í•  ìˆ˜ ìˆë‹¤. 

StackGuard

Not work!

BOFì™€ ë‹¬ë¦¬ FSBëŠ” target memoryë§Œ ìˆ˜ì •ì´ ê°€ëŠ¥í•˜ë‹¤, other memoryì€ ì˜í–¥ì„ ë°›ì§€ ì•ŠëŠ”ë‹¤. 

![Untitled](5%20Format%20S%202e31c/Untitled%2017.png)

> í•´ë‹¹í”„ë¡œê·¸ë¨ êµ¬ë™ì‹œ Stackìƒì— ì¼ì •ì£¼ì†Œë²ˆì§€ì— í”„ë¡œê·¸ë˜ë¨¸ê°€ ìœ ë„í•˜ëŠ” Canary ë¥¼ ì‹¬ì–´ë‘ê³  ìŠ¤íƒì´ ë¶•ê´´ë˜ê±°ë‚˜ ë³€ì¡°ë˜ì—ˆì„ê²½ìš° ìœ ë„ëœ Canaryë¥¼ ì²´í¬í•˜ì—¬ í”„ë¡œê·¸ë¨ì„ ë¹„ì •ìƒì¢…ë£Œ ì‹œí‚¤ëŠ” ë°©ë²•ì´ë‹¤. ì´ëŸ°í•œ ë°œìƒì€ í•¨ìˆ˜ì˜ ë¦¬í„´ì‹œ í”„ë¡œê·¸ë¨ì˜ íë¦„ì„ ë³€ì¡°í•˜ë ¤ëŠ” í•´ì»¤ë“¤ì˜ ê³µê²©ë°©ë²•ì„ ì—­ì´ìš©í•œê²ƒìœ¼ë¡œ ì•„ì£¼ ê°„ë‹¨í•˜ë©´ì„œë„ ìœ ìš©í•œ ë°©ë²•ì´ë‹¤.
>